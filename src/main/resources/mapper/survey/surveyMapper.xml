<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="study.dev.thboard3.survey.mapper.SurveyMapper">

    <!-- (μ™Έλ¶€)μ‚¬μ©μκ°€ μ‘μ‹ν• μ„¤λ¬Έ λ©λ΅ μ΅°ν -->
    <select id="selectExtSurveyList" parameterType="map" resultType="map">
    /* (μ™Έλ¶€)μ‚¬μ©μκ°€ μ‘μ‹ν• μ„¤λ¬Έ λ©λ΅ μ΅°ν */
    WITH G AS (
        SELECT
            UA.COMPANY_NM,
            UA.USER_ID,
            UA.USER_NM,
            SA.SESSION_KEY,
            MAX(SA.ANSWER_AT) AS ANSWER_AT,
            SUM(SA.SELECTED_SCORE) AS SELECTED_SCORE
        FROM SURVEY_ANSWER SA
        JOIN USER_ACCOUNT UA
          ON UA.USER_ID = SA.USER_ID
        WHERE SA.USER_ID = #{userId} /* π”‘ λ΅κ·ΈμΈν• μ‚¬μ©μ ID λ°”μΈλ”© */
        GROUP BY
            UA.COMPANY_NM,
            UA.USER_ID,
            UA.USER_NM,
            SA.SESSION_KEY
    )
    SELECT
      ROWNUM                 AS no,
      T.COMPANY_NM           AS companyNm,
      T.USER_ID              AS userId,
      T.USER_NM              AS userNm,
      T.ANSWER_AT             AS answerAt,
      T.SELECTED_SCORE            AS totalScore
    FROM (
      SELECT *
      FROM G
      ORDER BY G.ANSWER_AT DESC
    ) T
    </select>

    <!-- μ‚¬μ©μ λ³„ μ„¤λ¬Έ μƒμ„Έ μ΅°ν-->
    <select id="selectSurveyDetail" parameterType="map" resultType="map">
    /* μ„¤λ¬Έ μƒμ„Έ μ΅°ν */
    WITH base AS (
        SELECT
            SA.SESSION_KEY,
            UA.COMPANY_NM,
            UA.USER_ID,
            UA.USER_NM,
            SA.ANSWER_AT,
            SA.QUESTION_ID,
            SA.SELECTED_SCORE,
            QO.OPTION_TEXT
        FROM SURVEY_ANSWER SA
        JOIN USER_ACCOUNT     UA ON UA.USER_ID = SA.USER_ID
        JOIN QUESTION_OPTION  QO ON QO.OPTION_ID = SA.OPTION_ID
        WHERE SA.USER_ID    = #{userId} /* π”‘ μ‚¬μ©μ ID λ°”μΈλ”© */
          AND SA.SESSION_KEY = #{sessionKey} /* π”‘ μ„Έμ… ν‚¤ λ°”μΈλ”© */
    )
    SELECT
        MAX(company_nm) AS "μ—…μ²΄λ…",
        MAX(user_id) AS "ν‰κ°€μID",
        MAX(user_nm) AS "μ‚¬μ©μλ…",
        MAX(ANSWER_AT) AS "μ κ²€μΌμ‹",
        SUM(NVL(SELECTED_SCORE,0)) AS "μ΄ν•©μ μ",
        MAX(CASE WHEN QUESTION_ID = 1 THEN OPTION_TEXT END) AS "μ—…μΆ…",
        MAX(CASE WHEN QUESTION_ID = 2 THEN OPTION_TEXT END) AS "κ·λ¨",
        MAX(CASE WHEN QUESTION_ID = 3 THEN OPTION_TEXT END) AS "Q3_μ§μ±…",
        MAX(CASE WHEN QUESTION_ID = 4 THEN SELECTED_SCORE END) AS "Q4_μ μ",
        MAX(CASE WHEN QUESTION_ID = 5 THEN SELECTED_SCORE END) AS "Q5_μ μ",
        MAX(CASE WHEN QUESTION_ID = 6 THEN SELECTED_SCORE END) AS "Q6_μ μ",
        MAX(CASE WHEN QUESTION_ID = 7 THEN SELECTED_SCORE END) AS "Q7_μ μ",
        MAX(CASE WHEN QUESTION_ID = 8 THEN SELECTED_SCORE END) AS "Q8_μ μ",
        MAX(CASE WHEN QUESTION_ID = 9 THEN SELECTED_SCORE END) AS "Q9_μ μ"
    FROM base
    GROUP BY SESSION_KEY, user_id
    </select>

    <!-- (λ‚΄λ¶€)λ¨λ“  μ‚¬μ©μκ°€ μ‘μ‹ν• μ„¤λ¬Έμ΅°μ‚¬ λ°μ΄ν„° μ΅°ν(λ¨λ“  λ¬Έν•­, μ‘λ‹µ μ μ, μ΄ν•©) -->
    <select id="selectIntSurveyList" parameterType="map" resultType="map">
    /* (λ‚΄λ¶€)λ¨λ“  μ‚¬μ©μκ°€ μ‘μ‹ν• μ„¤λ¬Έμ΅°μ‚¬ λ°μ΄ν„° μ΅°ν(λ¨λ“  λ¬Έν•­, μ‘λ‹µ μ μ, μ΄ν•©) */
    WITH G AS (
        SELECT
            UA.COMPANY_NM,
            UA.USER_ID,
            UA.USER_NM,
            SA.SESSION_KEY,
            MAX(SA.ANSWER_AT)          AS "μ κ²€μΌμ‹",
            SUM(SA.SELECTED_SCORE)     AS "μ΄ν•©μ μ",

            -- λ¬Έν•­λ³„ μ μ ν”Όλ²— (Q1~Q9)
            MAX(CASE WHEN SA.QUESTION_ID = 1 THEN QO.OPTION_TEXT END) AS "λ¬Έν•­1",
            MAX(CASE WHEN SA.QUESTION_ID = 2 THEN QO.OPTION_TEXT END) AS "λ¬Έν•­2",
            MAX(CASE WHEN SA.QUESTION_ID = 3 THEN QO.OPTION_TEXT END) AS "λ¬Έν•­3",
            MAX(CASE WHEN SA.QUESTION_ID = 4 THEN SA.SELECTED_SCORE END) AS "λ¬Έν•­4",
            MAX(CASE WHEN SA.QUESTION_ID = 5 THEN SA.SELECTED_SCORE END) AS "λ¬Έν•­5",
            MAX(CASE WHEN SA.QUESTION_ID = 6 THEN SA.SELECTED_SCORE END) AS "λ¬Έν•­6",
            MAX(CASE WHEN SA.QUESTION_ID = 7 THEN SA.SELECTED_SCORE END) AS "λ¬Έν•­7",
            MAX(CASE WHEN SA.QUESTION_ID = 8 THEN SA.SELECTED_SCORE END) AS "λ¬Έν•­8",
            MAX(CASE WHEN SA.QUESTION_ID = 9 THEN SA.SELECTED_SCORE END) AS "λ¬Έν•­9"
        FROM SURVEY_ANSWER SA
        JOIN USER_ACCOUNT UA
          ON UA.USER_ID = SA.USER_ID
        JOIN QUESTION_OPTION QO
          ON SA.OPTION_ID = QO.OPTION_ID
        GROUP BY
            UA.COMPANY_NM,
            UA.USER_ID,
            UA.USER_NM,
            SA.SESSION_KEY
    ),
    S AS (
        SELECT
          COMPANY_NM, USER_ID, USER_NM, "μ κ²€μΌμ‹", "μ΄ν•©μ μ",
          "λ¬Έν•­1","λ¬Έν•­2","λ¬Έν•­3","λ¬Έν•­4","λ¬Έν•­5","λ¬Έν•­6","λ¬Έν•­7","λ¬Έν•­8","λ¬Έν•­9",
          ROW_NUMBER() OVER (PARTITION BY USER_ID ORDER BY "μ κ²€μΌμ‹" ASC) AS "νμ°¨"
        FROM G
        ORDER BY USER_ID, "μ κ²€μΌμ‹" DESC
    )
    SELECT
        ROWNUM                               AS "λ²νΈ",
        S."νμ°¨",
        S.COMPANY_NM                         AS "μ—…μ²΄λ…",
        S.USER_ID                            AS "ν‰κ°€μID",
        S.USER_NM                            AS "ν‰κ°€μλ…",
        S."μ κ²€μΌμ‹",
        S."μ΄ν•©μ μ",
        S."λ¬Έν•­1", S."λ¬Έν•­2", S."λ¬Έν•­3", S."λ¬Έν•­4", S."λ¬Έν•­5",
        S."λ¬Έν•­6", S."λ¬Έν•­7", S."λ¬Έν•­8", S."λ¬Έν•­9"
    FROM S
    </select>

    <!-- μ„¤λ¬Έ μ‘λ‹µ -->
    <insert id="insertSurvey" parameterType="map">
    /* μ„¤λ¬Έ μ‘λ‹µ */
    INSERT INTO SURVEY_ANSWER (
        USER_ID,
        SESSION_KEY,
        QUESTION_ID,
        OPTION_ID,
        SELECTED_SCORE
        -- ANSWER_ATμ€ DEFAULT SYSDATEλ΅ μλ™ μ‚½μ…λ¨
    )
    VALUES (
        #{userId},
        #{sessionKey},
        #{questionId},
        #{optionId},
        #{selectedScore, jdbcType=NUMERIC} /* π”‘ NULL ν—μ©μ„ μ„ν•΄ jdbcType λ…μ‹ */
    )
    </insert>





</mapper>