<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="study.dev.thboard3.survey.mapper.SurveyMapper">

    <!-- (외부)사용자가 응시한 설문 목록 조회 -->
    <select id="selectExtSurveyList" parameterType="map" resultType="map">
    /* (외부)사용자가 응시한 설문 목록 조회 */
    WITH G AS (
        SELECT
            UA.COMPANY_NM,
            UA.USER_ID,
            UA.USER_NM,
            SA.SESSION_KEY,
            MAX(SA.ANSWER_AT) AS ANSWER_AT,
            SUM(SA.SELECTED_SCORE) AS SELECTED_SCORE
        FROM SURVEY_ANSWER SA
        JOIN USER_ACCOUNT UA
          ON UA.USER_ID = SA.USER_ID
        WHERE SA.USER_ID = #{userId} /* 🔑 로그인한 사용자 ID 바인딩 */
        GROUP BY
            UA.COMPANY_NM,
            UA.USER_ID,
            UA.USER_NM,
            SA.SESSION_KEY
    )
    SELECT
      ROWNUM                 AS no,
      T.COMPANY_NM           AS companyNm,
      T.USER_ID              AS userId,
      T.USER_NM              AS userNm,
      T.SESSION_KEY AS sessionKey,
      T.ANSWER_AT             AS answerAt,
      T.SELECTED_SCORE            AS totalScore
    FROM (
      SELECT *
      FROM G
      ORDER BY G.ANSWER_AT DESC
    ) T
    </select>

    <!-- 사용자 별 설문 상세 조회-->
    <select id="selectSurveyDetail" parameterType="map" resultType="map">
    /* 설문 상세 조회 */
    WITH base AS (
        SELECT
            SA.SESSION_KEY,
            UA.COMPANY_NM,
            UA.USER_ID,
            UA.USER_NM,
            SA.ANSWER_AT,
            SA.QUESTION_ID,
            SA.SELECTED_SCORE,
            QO.OPTION_TEXT
        FROM SURVEY_ANSWER SA
        JOIN USER_ACCOUNT     UA ON UA.USER_ID = SA.USER_ID
        JOIN QUESTION_OPTION  QO ON QO.OPTION_ID = SA.OPTION_ID
        WHERE SA.USER_ID    = #{userId} /* 🔑 사용자 ID 바인딩 */
          AND SA.SESSION_KEY = #{sessionKey} /* 🔑 세션 키 바인딩 */
    )
    SELECT
        MAX(company_nm) AS companyNm,
        MAX(user_id) AS userId,
        MAX(user_nm) AS userNm,
        MAX(ANSWER_AT) AS answerAt,
        SUM(NVL(SELECTED_SCORE,0)) AS totalScore,
        MAX(CASE WHEN QUESTION_ID = 42 THEN OPTION_TEXT END) AS Q1_UPJONG,
        MAX(CASE WHEN QUESTION_ID = 43 THEN OPTION_TEXT END) AS Q2_KUMO,
        MAX(CASE WHEN QUESTION_ID = 44 THEN OPTION_TEXT END) AS Q3_JIKCHEK,
        MAX(CASE WHEN QUESTION_ID = 45 THEN SELECTED_SCORE END) AS Q4_SCORE,
        MAX(CASE WHEN QUESTION_ID = 46 THEN SELECTED_SCORE END) AS Q5_SCORE,
        MAX(CASE WHEN QUESTION_ID = 47 THEN SELECTED_SCORE END) AS Q6_SCORE,
        MAX(CASE WHEN QUESTION_ID = 48 THEN SELECTED_SCORE END) AS Q7_SCORE,
        MAX(CASE WHEN QUESTION_ID = 49 THEN SELECTED_SCORE END) AS Q8_SCORE,
        MAX(CASE WHEN QUESTION_ID = 50 THEN SELECTED_SCORE END) AS Q9_SCORE
    FROM base
    GROUP BY SESSION_KEY, user_id
    </select>

    <!-- (내부)모든 사용자가 응시한 설문조사 데이터 조회(모든 문항, 응답 점수, 총합) -->
    <select id="selectIntSurveyList" parameterType="map" resultType="map">
    /* (내부)모든 사용자가 응시한 설문조사 데이터 조회(모든 문항, 응답 점수, 총합) */
    WITH G AS (
        SELECT
            -- 🔑 G CTE 내부: 모든 컬럼에 별칭을 명시하여 외부 참조를 용이하게 함
            UA.COMPANY_NM AS COMPANYNM,
            UA.USER_ID AS USERID,
            UA.USER_NM AS USERNM,
            SA.SESSION_KEY AS SESSIONKEY,
            MAX(SA.ANSWER_AT) AS ANSWERAT,
            SUM(SA.SELECTED_SCORE) AS TOTALSCORE,

            -- 기본 정보 (텍스트)
            MAX(CASE WHEN SA.QUESTION_ID = 42 THEN QO.OPTION_TEXT END) AS Q1_UPJONG,
            MAX(CASE WHEN SA.QUESTION_ID = 43 THEN QO.OPTION_TEXT END) AS Q2_GYUMO,
            MAX(CASE WHEN SA.QUESTION_ID = 44 THEN QO.OPTION_TEXT END) AS Q3_JIKCHEK,

            -- 위험 및 대응 점수 (SCORE)
            MAX(CASE WHEN SA.QUESTION_ID = 45 THEN SA.SELECTED_SCORE END) AS Q4_SCORE,
            MAX(CASE WHEN SA.QUESTION_ID = 46 THEN SA.SELECTED_SCORE END) AS Q5_SCORE,
            MAX(CASE WHEN SA.QUESTION_ID = 47 THEN SA.SELECTED_SCORE END) AS Q6_SCORE,
            MAX(CASE WHEN SA.QUESTION_ID = 48 THEN SA.SELECTED_SCORE END) AS Q7_SCORE,
            MAX(CASE WHEN SA.QUESTION_ID = 49 THEN SA.SELECTED_SCORE END) AS Q8_SCORE,
            MAX(CASE WHEN SA.QUESTION_ID = 50 THEN SA.SELECTED_SCORE END) AS Q9_SCORE
        FROM SURVEY_ANSWER SA
        JOIN USER_ACCOUNT UA
          ON UA.USER_ID = SA.USER_ID
        JOIN QUESTION_OPTION QO
          ON SA.OPTION_ID = QO.OPTION_ID
        GROUP BY
            UA.COMPANY_NM, UA.USER_ID, UA.USER_NM, SA.SESSION_KEY
    ),
    S AS (
        -- 🔑 S CTE 내부: G의 모든 컬럼을 *명시적으로* 참조
        SELECT
          COMPANYNM, USERID, USERNM, ANSWERAT, TOTALSCORE, SESSIONKEY,
          Q1_UPJONG, Q2_GYUMO, Q3_JIKCHEK,
          Q4_SCORE, Q5_SCORE, Q6_SCORE, Q7_SCORE, Q8_SCORE, Q9_SCORE,
          -- 🔑 Window 함수: ORDER BY에 대문자 ANSWERAT 사용
          ROW_NUMBER() OVER (PARTITION BY USERID ORDER BY ANSWERAT ASC) AS attemptRank
        FROM G
        -- 🔑 ORDER BY: G에서 정의된 대문자 별칭을 사용해야 합니다.
        ORDER BY USERID, ANSWERAT DESC
    )
    SELECT
            ROWNUM AS no,
            S.attemptRank AS attemptRank,
            S.COMPANYNM AS companyNm,
            S.USERID AS userId,
            S.USERNM AS userNm,
            S.ANSWERAT AS answerAt,
            S.TOTALSCORE AS totalScore,
            S.Q1_UPJONG, S.Q2_GYUMO, S.Q3_JIKCHEK,
            S.Q4_SCORE, S.Q5_SCORE, S.Q6_SCORE, S.Q7_SCORE, S.Q8_SCORE, S.Q9_SCORE
    FROM S
    </select>

    <!-- 설문 응답 -->
    <insert id="insertSurveyAnswers" parameterType="list">
    /* * 최적화된 설문 응답 저장 (Multi-Row INSERT)
     * - UNION ALL을 사용하여 하나의 SQL 문으로 여러 행 삽입
     * - ORA-00933, ORA-00001 (무결성) 오류 방지
     */

    INSERT INTO SURVEY_ANSWER (
        USER_ID, SESSION_KEY, QUESTION_ID, OPTION_ID, SELECTED_SCORE
    )
    SELECT
        T.USER_ID, T.SESSION_KEY, T.QUESTION_ID, T.OPTION_ID, T.SELECTED_SCORE
    FROM
    (
        <foreach collection="list" item="item" separator=" UNION ALL ">
            SELECT
                #{item.userId} AS USER_ID,
                #{item.sessionKey} AS SESSION_KEY,
                #{item.questionId} AS QUESTION_ID,
                #{item.optionId} AS OPTION_ID,
                NVL(#{item.selectedScore, jdbcType=NUMERIC}, 0) AS SELECTED_SCORE
            FROM DUAL
        </foreach>
    ) T
    </insert>

    <select id="selectMaxSessionKeyNumber" resultType="int">
    /* 특정 사용자의 SESSION_KEY 최대 순번 조회 */
    SELECT
        NVL(
            MAX(
                TO_NUMBER(SUBSTR(SA.SESSION_KEY, INSTR(SA.SESSION_KEY, '_') + 1))
            ),
            0
        )
    FROM
        SURVEY_ANSWER SA
    WHERE
        SA.USER_ID = #{userId}
    </select>

    <delete id="deletePreviousAnswers" parameterType="string">
    /* 특정 세션 키의 모든 응답 기록 삭제 (덮어쓰기 허용) */
    DELETE FROM SURVEY_ANSWER
    WHERE SESSION_KEY = #{sessionKey}
    </delete>


</mapper>