<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="study.dev.thboard3.survey.mapper.SurveyMapper">

    <!-- (μ™Έλ¶€)μ‚¬μ©μκ°€ μ‘μ‹ν• μ„¤λ¬Έ λ©λ΅ μ΅°ν -->
    <select id="selectExtSurveyList" parameterType="map" resultType="map">
        /* π”‘ (μ™Έλ¶€)μ‚¬μ©μκ°€ μ‘μ‹ν• μ„¤λ¬Έ λ©λ΅ μ΅°ν (Pagination + Total Count) */
        WITH G AS (
            -- 1. μ‘μ‹ νμ°¨λ³„ κΈ°λ³Έ μ§‘κ³„ λ°μ΄ν„° μƒμ„±
            SELECT
                UA.COMPANY_NM,
                UA.USER_ID,
                UA.USER_NM,
                SA.SESSION_KEY,
                MAX(SA.ANSWER_AT) AS ANSWERAT,
                SUM(SA.SELECTED_SCORE) AS TOTALSCORE
            FROM SURVEY_ANSWER SA
            JOIN USER_ACCOUNT UA
              ON UA.USER_ID = SA.USER_ID
            WHERE SA.USER_ID = #{userId} /* π”‘ λ΅κ·ΈμΈν• μ‚¬μ©μ ID λ°”μΈλ”© */
            GROUP BY
                UA.COMPANY_NM,
                UA.USER_ID,
                UA.USER_NM,
                SA.SESSION_KEY
        ),
        RankedList AS (
            -- 2. π”‘ ROW_NUMBER()μ™€ μ „μ²΄ COUNT(*) OVER()λ¥Ό λ™μ‹μ— κ³„μ‚°ν•μ—¬ μμ„λ¥Ό λ§¤κΉ€
            SELECT
                ROW_NUMBER() OVER (ORDER BY G.ANSWERAT DESC) AS rn,  /* π”‘ μμ„ λ²νΈ */
                COUNT(*) OVER() AS totalCount,                      /* π”‘ μ „μ²΄ ν–‰ κ°μ */
                G.COMPANY_NM           AS companyNm,
                G.USER_ID              AS userId,
                G.USER_NM              AS userNm,
                G.SESSION_KEY          AS sessionKey,
                G.ANSWERAT            AS answerAt,
                G.TOTALSCORE          AS totalScore
            FROM G
        )
        -- 3. μµμΆ… Pagination ν•„ν„°λ§ λ° μ»¬λΌ μ„ νƒ
        SELECT
              rn AS no, /* π”‘ μμ„ λ²νΈλ¥Ό 'no'λ΅ λ°ν™ */
              totalCount AS extSurveyListCount, /* π”‘ μ „μ²΄ κ°μλ¥Ό 'extSurveyListCount'λ΅ λ°ν™ */
              companyNm,
              userId,
              userNm,
              sessionKey,
              answerAt,
              totalScore
        FROM RankedList
        /* π”‘ Pagination λ²”μ„ μ΅°κ±΄ */
        WHERE rn <![CDATA[ <= ]]> #{cmmnVo.lastRecordIndex}
          AND rn <![CDATA[ >= ]]> #{cmmnVo.firstRecordIndex}
        ORDER BY rn
    </select>

    <!-- μ‚¬μ©μ λ³„ μ„¤λ¬Έ μƒμ„Έ μ΅°ν-->
    <select id="selectSurveyDetail" parameterType="map" resultType="map">
    /* μ„¤λ¬Έ μƒμ„Έ μ΅°ν */
    WITH base AS (
        SELECT
            SA.SESSION_KEY,
            UA.COMPANY_NM,
            UA.USER_ID,
            UA.USER_NM,
            SA.ANSWER_AT,
            SA.QUESTION_ID,
            SA.SELECTED_SCORE,
            QO.OPTION_TEXT
        FROM SURVEY_ANSWER SA
        JOIN USER_ACCOUNT     UA ON UA.USER_ID = SA.USER_ID
        JOIN QUESTION_OPTION  QO ON QO.OPTION_ID = SA.OPTION_ID
        WHERE SA.USER_ID    = #{userId} /* π”‘ μ‚¬μ©μ ID λ°”μΈλ”© */
          AND SA.SESSION_KEY = #{sessionKey} /* π”‘ μ„Έμ… ν‚¤ λ°”μΈλ”© */
    )
    SELECT
        MAX(company_nm) AS companyNm,
        MAX(user_id) AS userId,
        MAX(user_nm) AS userNm,
        MAX(ANSWER_AT) AS answerAt,
        SUM(NVL(SELECTED_SCORE,0)) AS totalScore,
        MAX(CASE WHEN QUESTION_ID = 42 THEN OPTION_TEXT END) AS Q1_UPJONG,
        MAX(CASE WHEN QUESTION_ID = 43 THEN OPTION_TEXT END) AS Q2_KUMO,
        MAX(CASE WHEN QUESTION_ID = 44 THEN OPTION_TEXT END) AS Q3_JIKCHEK,
        MAX(CASE WHEN QUESTION_ID = 45 THEN SELECTED_SCORE END) AS Q4_SCORE,
        MAX(CASE WHEN QUESTION_ID = 46 THEN SELECTED_SCORE END) AS Q5_SCORE,
        MAX(CASE WHEN QUESTION_ID = 47 THEN SELECTED_SCORE END) AS Q6_SCORE,
        MAX(CASE WHEN QUESTION_ID = 48 THEN SELECTED_SCORE END) AS Q7_SCORE,
        MAX(CASE WHEN QUESTION_ID = 49 THEN SELECTED_SCORE END) AS Q8_SCORE,
        MAX(CASE WHEN QUESTION_ID = 50 THEN SELECTED_SCORE END) AS Q9_SCORE
    FROM base
    GROUP BY SESSION_KEY, user_id
    </select>

    <!-- (λ‚΄λ¶€)λ¨λ“  μ‚¬μ©μκ°€ μ‘μ‹ν• μ„¤λ¬Έμ΅°μ‚¬ λ°μ΄ν„° μ΅°ν(λ¨λ“  λ¬Έν•­, μ‘λ‹µ μ μ, μ΄ν•©) -->
    <select id="selectIntSurveyList" parameterType="map" resultType="map">
    /* (λ‚΄λ¶€)λ¨λ“  μ‚¬μ©μκ°€ μ‘μ‹ν• μ„¤λ¬Έμ΅°μ‚¬ λ°μ΄ν„° μ΅°ν(λ¨λ“  λ¬Έν•­, μ‘λ‹µ μ μ, μ΄ν•©) */
    WITH G AS (
        SELECT
            -- π”‘ G CTE λ‚΄λ¶€: λ¨λ“  μ»¬λΌμ— λ³„μΉ­μ„ λ…μ‹ν•μ—¬ μ™Έλ¶€ μ°Έμ΅°λ¥Ό μ©μ΄ν•κ² ν•¨
            UA.COMPANY_NM AS COMPANYNM,
            UA.USER_ID AS USERID,
            UA.USER_NM AS USERNM,
            SA.SESSION_KEY AS SESSIONKEY,
            MAX(SA.ANSWER_AT) AS ANSWERAT,
            SUM(SA.SELECTED_SCORE) AS TOTALSCORE,

            -- κΈ°λ³Έ μ •λ³΄ (ν…μ¤νΈ)
            MAX(CASE WHEN SA.QUESTION_ID = 42 THEN QO.OPTION_TEXT END) AS Q1_UPJONG,
            MAX(CASE WHEN SA.QUESTION_ID = 43 THEN QO.OPTION_TEXT END) AS Q2_GYUMO,
            MAX(CASE WHEN SA.QUESTION_ID = 44 THEN QO.OPTION_TEXT END) AS Q3_JIKCHEK,

            -- μ„ν— λ° λ€μ‘ μ μ (SCORE)
            MAX(CASE WHEN SA.QUESTION_ID = 45 THEN SA.SELECTED_SCORE END) AS Q4_SCORE,
            MAX(CASE WHEN SA.QUESTION_ID = 46 THEN SA.SELECTED_SCORE END) AS Q5_SCORE,
            MAX(CASE WHEN SA.QUESTION_ID = 47 THEN SA.SELECTED_SCORE END) AS Q6_SCORE,
            MAX(CASE WHEN SA.QUESTION_ID = 48 THEN SA.SELECTED_SCORE END) AS Q7_SCORE,
            MAX(CASE WHEN SA.QUESTION_ID = 49 THEN SA.SELECTED_SCORE END) AS Q8_SCORE,
            MAX(CASE WHEN SA.QUESTION_ID = 50 THEN SA.SELECTED_SCORE END) AS Q9_SCORE
        FROM SURVEY_ANSWER SA
        JOIN USER_ACCOUNT UA
          ON UA.USER_ID = SA.USER_ID
        JOIN QUESTION_OPTION QO
          ON SA.OPTION_ID = QO.OPTION_ID
        JOIN QUESTION Q
          ON SA.QUESTION_ID = Q.QUESTION_ID
        GROUP BY
            UA.COMPANY_NM, UA.USER_ID, UA.USER_NM, SA.SESSION_KEY
    ),
    S AS (
        -- π”‘ S CTE λ‚΄λ¶€: Gμ λ¨λ“  μ»¬λΌμ„ *λ…μ‹μ μΌλ΅* μ°Έμ΅°
        SELECT
          COMPANYNM,
          USERID,
          USERNM,
          ANSWERAT,
          TOTALSCORE,
          SESSIONKEY,
          Q1_UPJONG, Q2_GYUMO, Q3_JIKCHEK,
          Q4_SCORE, Q5_SCORE, Q6_SCORE, Q7_SCORE, Q8_SCORE, Q9_SCORE,
          ROW_NUMBER() OVER (PARTITION BY USERID ORDER BY ANSWERAT ASC) AS attemptRank
        FROM G
        ORDER BY USERID, ANSWERAT DESC
    )
    SELECT
            ROWNUM AS no,
            S.attemptRank AS attemptRank,
            S.COMPANYNM AS companyNm,
            S.USERID AS userId,
            S.USERNM AS userNm,
            S.ANSWERAT AS answerAt,
            S.TOTALSCORE AS totalScore,
            S.Q1_UPJONG, S.Q2_GYUMO, S.Q3_JIKCHEK,
            S.Q4_SCORE, S.Q5_SCORE, S.Q6_SCORE, S.Q7_SCORE, S.Q8_SCORE, S.Q9_SCORE
    FROM S
    </select>

    <!-- μ„¤λ¬Έ μ‘λ‹µ -->
    <insert id="insertSurveyAnswers" parameterType="list">
    /* * μµμ ν™”λ μ„¤λ¬Έ μ‘λ‹µ μ €μ¥ (Multi-Row INSERT)
     * - UNION ALLμ„ μ‚¬μ©ν•μ—¬ ν•λ‚μ SQL λ¬ΈμΌλ΅ μ—¬λ¬ ν–‰ μ‚½μ…
     * - ORA-00933, ORA-00001 (λ¬΄κ²°μ„±) μ¤λ¥ λ°©μ§€
     */

    INSERT INTO SURVEY_ANSWER (
        USER_ID, SESSION_KEY, QUESTION_ID, OPTION_ID, SELECTED_SCORE
    )
    SELECT
        T.USER_ID, T.SESSION_KEY, T.QUESTION_ID, T.OPTION_ID, T.SELECTED_SCORE
    FROM
    (
        <foreach collection="list" item="item" separator=" UNION ALL ">
            SELECT
                #{item.userId} AS USER_ID,
                #{item.sessionKey} AS SESSION_KEY,
                #{item.questionId} AS QUESTION_ID,
                #{item.optionId} AS OPTION_ID,
                NVL(#{item.selectedScore, jdbcType=NUMERIC}, 0) AS SELECTED_SCORE
            FROM DUAL
        </foreach>
    ) T
    </insert>

    <select id="selectMaxSessionKeyNumber" resultType="int">
    /* νΉμ • μ‚¬μ©μμ SESSION_KEY μµλ€ μλ² μ΅°ν */
    SELECT
        NVL(
            MAX(
                TO_NUMBER(SUBSTR(SA.SESSION_KEY, INSTR(SA.SESSION_KEY, '_') + 1))
            ),
            0
        )
    FROM
        SURVEY_ANSWER SA
    WHERE
        SA.USER_ID = #{userId}
    </select>

    <select id="selectSurveyQuestionsForRegister" resultType="map">
    /* λ™μ  ν™”λ©΄ μƒμ„±μ„ μ„ν•΄ λ¨λ“  λ¬Έν•­ λ° μµμ… μ΅°ν */
    SELECT
        Q.QUESTION_ID AS questionId,
        Q.QUESTION_NUM AS questionNum,
        Q.QUESTION_TEXT AS questionText,
        Q.TYPE_CODE_NM AS typeCodeNm,
        QO.OPTION_ID AS optionId,
        QO.OPTION_ORDER AS optionOrder,
        QO.OPTION_TEXT AS optionText,
        QO.OPTION_SCORE AS optionScore
    FROM
        QUESTION Q
    JOIN
        QUESTION_OPTION QO ON Q.QUESTION_ID = QO.QUESTION_ID
    ORDER BY
        Q.QUESTION_ID, QO.OPTION_ORDER
    </select>

</mapper>