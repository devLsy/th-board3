<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>안전점검 자율진단 설문 등록</title>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; max-width: 900px; margin: 20px auto; padding: 25px; background-color: #f8f8f8; }
        .question-group { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 6px; background-color: #fff; }
        .question-text { font-weight: bold; margin-bottom: 10px; color: #1e8449; }
        .option-item { margin-left: 15px; margin-bottom: 5px; }
        .option-item label { cursor: pointer; }
        .part-header { font-size: 1.3em; color: navy; margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid navy; padding-bottom: 5px; }

        /* 버튼 스타일 */
        .button-container { text-align: center; margin-top: 40px; }
        .submit-btn { padding: 10px 20px; font-size: 1.1em; background-color: #1e8449; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 0 10px; }
        .list-btn { padding: 10px 20px; font-size: 1.1em; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 0 10px; }
    </style>
</head>
<body>

    <h2>안전점검 자율진단표 - 신규 등록</h2>
    <form id="surveyForm">

        <input type="hidden" id="USER_ID" name="USER_ID" th:value="${userId}">
        <input type="hidden" id="SESSION_KEY" name="SESSION_KEY" th:value="${sessionKey}">
        <p>평가자: [[${userId}]] | 응시 회차: [[${sessionKey}]]</p>

        <div id="questionsContainer">
            <p style="text-align: center; color: gray;">설문 문항을 불러오는 중입니다...</p>
        </div>

        <div class="button-container">
            <button type="button" id="listBtn" class="list-btn">목록으로 돌아가기</button>
            <button type="button" id="submitBtn" class="submit-btn">설문 제출하기</button>
        </div>
    </form>

    <script th:inline="javascript">
    /* <![CDATA[ */
    $(document).ready(function() {

        // 1. 페이지 로드 완료 시 문항 데이터 AJAX 호출
        loadSurveyQuestions();

        function loadSurveyQuestions() {
            $.ajax({
                url: '/survey/api/questions', // 🔑 JSON API 호출
                type: 'GET',
                dataType: 'json',
                success: function(surveyData) {
                    // 2. AJAX 성공 시, HTML 동적 생성
                    renderQuestions(surveyData);
                    $('#submitBtn').prop('disabled', false); // 제출 버튼 활성화
                },
                error: function(xhr) {
                    $('#questionsContainer').html('<p style="color:red; text-align:center;">문항을 불러오는데 실패했습니다.</p>');
                    console.error("Failed to load questions:", xhr);
                }
            });
        }

        function renderQuestions(surveyData) {
            const container = $('#questionsContainer');
            container.empty();

            $.each(surveyData, function(qIndex, question) {
                // Part Header 구분
                const qNum = question.questionNum;
                const typeCode = question.typeCodeNm;

                if (qNum === 1) {
                    let headerText = '';
                    if (typeCode && typeCode.includes('기본정보')) {
                        headerText = 'Part 1. (기본정보) 공통사항';
                    } else if (typeCode && typeCode.includes('위험')) {
                        headerText = 'Part 2. 위험 및 대응';
                    }
                    // TYPE_CODE_NM이 예상 범위에 있을 때만 헤더 출력
                    if (headerText) {
                         container.append(`<div class="part-header">${headerText}</div>`);
                    }
                }

                let questionHtml = `
                    <div class="question-group" data-qid="${question.questionId}">
                        <p class="question-text">${question.questionNum}. ${question.questionText}</p>
                        <input type="hidden" name="Q_${question.questionId}_ID" value="${question.questionId}">
                `;

                $.each(question.options, function(oIndex, option) {
                    const optionId = option.optionId;
                    const qId = question.questionId;
                    const score = option.optionScore === null ? '' : option.optionScore;
                    const scoreText = score === '' ? '' : ` (${score}점)`;

                    questionHtml += `
                        <div class="option-item">
                            <input type="radio" id="q${qId}_opt${optionId}" name="Q_${qId}_OPT" value="${optionId}">
                            <label for="q${qId}_opt${optionId}">${option.optionText} ${scoreText}</label>
                            <input type="hidden" name="Q_${qId}_SCORE_${optionId}" value="${score}">
                        </div>
                    `;
                });

                questionHtml += `</div>`; // .question-group 닫기
                container.append(questionHtml);
            });
        }

        // 🔑 제출 버튼 클릭 이벤트
        $('#submitBtn').on('click', function() {

            if (!confirm("설문을 최종 제출하시겠습니까? 제출 후에는 수정할 수 없습니다.")) {
                return;
            }

            const formData = collectFormData();

            // 🚨 경고: 미응답 문항이 있으면 경고 후 강제 제출 (개발 테스트용)
            if (formData.answers.length !== 9) {
                alert(`경고: ${9 - formData.answers.length}개 문항에 답변하지 않았습니다. 미응답 항목은 0점으로 처리 후 강제 제출됩니다.`);
                return;
            }

            $.ajax({
                url: '/survey/ext/save',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    alert('설문이 성공적으로 저장되었습니다.');
                    window.location.href = '/survey/ext/list?userId=' + $('#USER_ID').val();
                },
                error: function(xhr) {
                    alert('설문 저장 중 오류가 발생했습니다.');
                }
            });
        });

        // 🔑 목록 버튼 클릭 이벤트
        $('#listBtn').on('click', function() {
            const userId = $('#USER_ID').val();
            window.location.href = '/survey/ext/list?userId=' + userId;
        });


        // 🔑 제출 데이터 수집 및 가공 함수
        function collectFormData() {
            const userId = $('#USER_ID').val();
            const sessionKey = $('#SESSION_KEY').val();
            const answers = [];

            $('.question-group').each(function() {
                const qid = $(this).data('qid');
                const selectedRadio = $(`input[name="Q_${qid}_OPT"]:checked`);

                if (selectedRadio.length > 0) {
                    const optionId = selectedRadio.val();
                    // 점수 Hidden Field는 Q_ID와 OPTION_ID를 조합하여 정확히 찾음
                    const scoreField = $(`input[name="Q_${qid}_SCORE_${optionId}"]`);

                    let scoreValue = scoreField.val();

                    if (scoreValue === "" || scoreValue === "NULL" || scoreValue === null) {
                         scoreValue = null; // DB의 NULL 처리 (Mapper에서 0으로 NVL 처리됨)
                    } else {
                        scoreValue = parseInt(scoreValue, 10);
                    }

                    answers.push({
                        userId: userId,
                        sessionKey: sessionKey,
                        questionId: parseInt(qid, 10),
                        optionId: parseInt(optionId, 10),
                        selectedScore: scoreValue
                    });
                }
            });

            return {
                userId: userId,
                sessionKey: sessionKey,
                answers: answers
            };
        }
    });
    /* ]]> */
    </script>
</body>
</html>