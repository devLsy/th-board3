<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì•ˆì „ì ê²€ ììœ¨ì§„ë‹¨ ì„¤ë¬¸ ë“±ë¡</title>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; max-width: 900px; margin: 20px auto; padding: 25px; background-color: #f8f8f8; }
        .question-group { margin-bottom: 0; padding: 0; border: none; background-color: transparent; } /* TR ë‚´ë¶€ì—ì„œ DIVëŠ” ìŠ¤íƒ€ì¼ ìµœì†Œí™” */
        .question-text { font-weight: bold; margin-bottom: 10px; color: #1e8449; }
        .option-item { margin-left: 15px; margin-bottom: 5px; }
        .option-item label { cursor: pointer; }
        .part-header { font-size: 1.3em; color: navy; margin-top: 0; margin-bottom: 0; border-bottom: 2px solid navy; padding-bottom: 5px; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .survey-reg-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .survey-reg-table th, .survey-reg-table td { border: 1px solid #e0e0e0; padding: 10px; text-align: left; vertical-align: top; }
        .survey-reg-table th { background-color: #f2f2f2; font-weight: bold; }
        .question-text-cell { width: 40%; background-color: #f9f9f9; }
        .option-cell { width: 60%; }
        .part-header-row td { background-color: #d1e7dd; color: navy; font-size: 1.2em; font-weight: bold; text-align: left !important; padding: 10px; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .button-container { text-align: center; margin-top: 40px; }
        .submit-btn { padding: 10px 20px; font-size: 1.1em; background-color: #1e8449; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 0 10px; }
        .list-btn { padding: 10px 20px; font-size: 1.1em; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 0 10px; }
    </style>
</head>
<body>

    <h2>ì•ˆì „ì ê²€ ììœ¨ì§„ë‹¨í‘œ - ì‹ ê·œ ë“±ë¡</h2>
    <form id="surveyForm">

        <input type="hidden" id="USER_ID" name="USER_ID" th:value="${userId}">
        <input type="hidden" id="SESSION_KEY" name="SESSION_KEY" th:value="${sessionKey}">
        <p>í‰ê°€ì: [[${userId}]] | ì‘ì‹œ íšŒì°¨: [[${sessionKey}]]</p>

        <table class="survey-reg-table">
            <thead>
                <tr>
                    <th style="width: 40%;">ë¬¸í•­ ë²ˆí˜¸ ë° ë‚´ìš©</th>
                    <th style="width: 60%;">ì„ íƒ ì˜µì…˜</th>
                </tr>
            </thead>
            <tbody id="questionsBody">
                <tr id="loadingRow">
                     <td colspan="2" style="text-align: center; color: gray;">ì„¤ë¬¸ ë¬¸í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td>
                </tr>
            </tbody>
        </table>

        <div class="button-container">
            <button type="button" id="listBtn" class="list-btn">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            <button type="button" id="submitBtn" class="submit-btn" disabled>ì„¤ë¬¸ ì œì¶œí•˜ê¸°</button>
        </div>
    </form>

    <script th:inline="javascript">
    /* <![CDATA[ */
    $(document).ready(function() {

        // 1. í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ë¬¸í•­ ë°ì´í„° AJAX í˜¸ì¶œ
        loadSurveyQuestions();

        function loadSurveyQuestions() {
            $.ajax({
                url: '/survey/api/questions',
                type: 'GET',
                dataType: 'json',
                success: function(surveyData) {
                    renderQuestions(surveyData);
                    $('#submitBtn').prop('disabled', false);
                },
                error: function(xhr) {
                    $('#questionsBody').html('<tr><td colspan="2" style="color:red; text-align:center;">ë¬¸í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì„œë²„ API í™•ì¸)</td></tr>');
                    console.error("Failed to load questions:", xhr);
                }
            });
        }

        function renderQuestions(surveyData) {
            const tbody = $('#questionsBody');
            tbody.empty();

            let currentPartNumber = 0;

            // 1. Question ê°ì²´ë¥¼ ìˆœíšŒí•˜ëŠ” ì£¼ Loop (surveyDataëŠ” Question List)
            $.each(surveyData, function(qIndex, question) {

                // Question DataëŠ” question ê°ì²´ì—ì„œ ì§ì ‘ ì°¸ì¡° (ì¹´ë©œ ì¼€ì´ìŠ¤)
                const questionId = question.questionId;
                const qNum = question.questionNum;
                const typeCode = question.typeCodeNm;
                const questionText = question.questionText;

                // 1-1. Part Header ì¶œë ¥ ë° Part Number ì—…ë°ì´íŠ¸
                if (qNum === 1) {
                    let headerText = '';
                    if (typeCode && typeCode.includes('ê¸°ë³¸ì •ë³´')) {
                        headerText = 'Part 1. (ê¸°ë³¸ì •ë³´) ê³µí†µì‚¬í•­';
                        currentPartNumber = 1;
                    } else if (typeCode && typeCode.includes('ìœ„í—˜')) {
                        headerText = 'Part 2. ìœ„í—˜ ë° ëŒ€ì‘';
                        currentPartNumber = 2;
                    }
                    if (headerText) {
                         // ğŸ”‘ TR í˜•íƒœë¡œ TBODYì— Part Header ì‚½ì…
                         tbody.append(`<tr class="part-header-row"><td colspan="2"><div class="part-header">${headerText}</div></td></tr>`);
                    }
                }

                // 2. ìƒˆ TR ë° TD ì‹œì‘
                const displayNum = (currentPartNumber > 0) ? `${currentPartNumber}-${qNum}` : `${qNum}`;

                const $currentQuestionRow = $(`<tr class="question-row" data-qid="${questionId}" data-displaynum="${displayNum}"></tr>`);
                tbody.append($currentQuestionRow);

                // 3. ë¬¸í•­ í…ìŠ¤íŠ¸ TD (ì²« ë²ˆì§¸ ì…€)
                $currentQuestionRow.append(`
                    <td class="question-text-cell">
                        <p class="question-text">${displayNum}. ${questionText}</p>
                        <input type="hidden" name="Q_${questionId}_ID" value="${questionId}">
                    </td>
                `);

                // 4. ì˜µì…˜ ì…€ (ë‘ ë²ˆì§¸ ì…€) ì‹œì‘
                const $optionCell = $('<td class="option-cell"></td>');
                $currentQuestionRow.append($optionCell);

                // 5. ğŸ”‘ options ë°°ì—´ì„ ì¤‘ì²© ìˆœíšŒí•˜ë©° ì˜µì…˜ HTML ìƒì„±
                $.each(question.options, function(oIndex, option) {
                    const optionId = option.optionId;
                    const score = option.optionScore === null ? '' : option.optionScore;
                    const scoreText = score === '' ? '' : ` (${score}ì )`;

                    const optionHtml = `
                        <div class="option-item">
                            <input type="radio" id="q${questionId}_opt${optionId}" name="Q_${questionId}_OPT" value="${optionId}">
                            <label for="q${questionId}_opt${optionId}">${option.optionText} ${scoreText}</label>
                            <input type="hidden" name="Q_${questionId}_SCORE_${optionId}" value="${score}">
                        </div>
                    `;
                    $optionCell.append(optionHtml); // ì˜µì…˜ ì…€ì— ì‚½ì…
                });
            });
        }

        // ğŸ”‘ ì œì¶œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        $('#submitBtn').on('click', function() {

            if (!confirm("ì„¤ë¬¸ì„ ìµœì¢… ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì œì¶œ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                return;
            }

            // 1. ìœ íš¨ì„± ê²€ì‚¬ë§Œ ì‹¤í–‰
            const missingQuestionNum = validateFirstMissingQuestion();

            // 2. ë¯¸ì‘ë‹µ ë¬¸í•­ ì²˜ë¦¬ ë° í•„ìˆ˜ ê²€ì¦
            if (missingQuestionNum) {
                alert(`ì˜¤ë¥˜: [${missingQuestionNum}]ë²ˆ ë¬¸í•­ì— ë°˜ë“œì‹œ ë‹µë³€í•´ì•¼ í•©ë‹ˆë‹¤.`);
                return;
            }

            // 3. ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼ í›„, ë°ì´í„° ìˆ˜ì§‘
            const formData = collectFormData();

            $.ajax({
                url: '/survey/ext/save',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                        alert('ì„¤ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        location.href = "/survey/ext/list";
                },
                error: function(xhr) {
                    alert('ì„¤ë¬¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });

        // ğŸ”‘ ëª©ë¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        $('#listBtn').on('click', function() {
            const userId = $('#USER_ID').val();
            window.location.href = '/survey/ext/list?userId=' + userId;
        });

        // ğŸ”‘ ì œì¶œ ë°ì´í„° ìˆ˜ì§‘ ë° ê°€ê³µ í•¨ìˆ˜ (TR êµ¬ì¡°ì— ë§ê²Œ Selector ì‚¬ìš©)
        function collectFormData() {
            const userId = $('#USER_ID').val();
            const sessionKey = $('#SESSION_KEY').val();
            const answers = [];

            // TBODY ë‚´ì˜ ëª¨ë“  TR.question-rowë¥¼ ìˆœíšŒ
            $('#questionsBody tr.question-row').each(function() {
                const $row = $(this);
                const qid = $row.data('qid');
                // í•´ë‹¹ TR ë‚´ë¶€ì—ì„œ ì„ íƒëœ Radio ë²„íŠ¼ì„ ì°¾ìŒ
                const selectedRadio = $row.find(`input[name="Q_${qid}_OPT"]:checked`);

                if (selectedRadio.length > 0) {
                    const optionId = selectedRadio.val();
                    const scoreField = $row.find(`input[name="Q_${qid}_SCORE_${optionId}"]`);

                    let scoreValue = scoreField.val();

                    if (scoreValue === "" || scoreValue === "NULL" || scoreValue === null) {
                        scoreValue = null;
                    } else {
                        scoreValue = parseInt(scoreValue, 10);
                    }

                    answers.push({
                        userId: userId,
                        sessionKey: sessionKey,
                        questionId: parseInt(qid, 10),
                        optionId: parseInt(optionId, 10),
                        selectedScore: scoreValue
                    });
                }
            });

            return {
                userId: userId,
                sessionKey: sessionKey,
                answers: answers
            };
        }

        // ì²« ë²ˆì§¸ ë¯¸ì‘ë‹µ ë¬¸í•­ ë²ˆí˜¸ë§Œ ì°¾ì•„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ (validation)
        function validateFirstMissingQuestion() {
            let missingNum = null;

            // TRì„ ìˆœíšŒí•˜ë©° ì²« ë²ˆì§¸ ë¯¸ì‘ë‹µ ë¬¸í•­ì„ ì°¾ìŠµë‹ˆë‹¤.
            $('#questionsBody tr.question-row').each(function() {
                const $row = $(this);
                const qid = $row.data('qid');
                const selectedRadio = $row.find(`input[name="Q_${qid}_OPT"]:checked`);

                if (selectedRadio.length === 0) {
                    // ë¯¸ì‘ë‹µ ë°œê²¬ ì‹œ ë²ˆí˜¸ ì €ì¥ í›„ ë£¨í”„ ì¤‘ë‹¨ (break)
                    missingNum = $row.data('displaynum');
                    return false; // jQuery .each() ë£¨í”„ë¥¼ ì¤‘ë‹¨í•˜ëŠ” ë°©ë²•
                }
            });

            return missingNum; // '1-1' í˜•íƒœì˜ ë²ˆí˜¸ ë˜ëŠ” null ë°˜í™˜
        }
    });
    /* ]]> */
    </script>
</body>
</html>