<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ìƒì„¸ ë³´ê¸° ë° ìˆ˜ì •</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <style>
        body { background-color: #f8f9fa; padding-top: 30px; }
        .container { max-width: 900px; }

        /* ğŸ”‘ ê²Œì‹œê¸€ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .post-header { margin-bottom: 20px; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }
        .post-header h1 { font-size: 1.8rem; font-weight: 700; color: #343a40; }
        .post-content-area {
            border: 1px solid #dee2e6;
            padding: 15px;
            min-height: 150px;
            margin-bottom: 20px;
            background-color: #ffffff;
            border-radius: 5px;
        }

        /* ğŸ”‘ ëŒ“ê¸€ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .comment-container {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .comment-header { font-size: 0.9rem; color: #6c757d; }
        .replyContentArea {
            border: none;
            width: 100%;
            background: transparent;
            resize: none;
            padding: 0;
            font-size: 1rem;
        }
        .replyContentArea:focus {
            outline: none;
        }
    </style>
</head>
<body>
    <div class="container">

        <form id="boardForm">
        <th:block th:if="${info?.boardSno != null}">
            <div class="post-header">
                <input type="hidden" name="boardSno" id="boardSno" th:value="${info.boardSno}">
                <h1><input type="text" name="title" id="title" th:value="${info.title}" class="form-control fw-bold fs-5"></h1>
            </div>

            <div class="post-content-area">
                <textarea name="content" id="content" th:text="${info.content}" class="form-control" style="border: none; height: 100%; min-height: 150px;"></textarea>
            </div>

            <div class="d-flex justify-content-end mb-4">
                <button id="modBtn" type="button" class="btn btn-primary me-2">ìˆ˜ì •</button>
                <a th:href="@{/board/list}" class="btn btn-secondary">ëª©ë¡</a>
            </div>
        </th:block>

        <th:block th:unless="${info?.boardSno != null}">
            <h1 class="mb-4">ìƒˆ ê¸€ ì‘ì„±</h1>
            <input type="hidden" name="boardSno" id="boardSno" th:value="${info.boardSno}">
            <input type="text" id="title" name="title" placeholder="ì œëª©" class="form-control mb-3">
            <textarea id="content" name="content" placeholder="ë‚´ìš©" class="form-control mb-3" rows="8"></textarea>

            <div class="d-flex justify-content-end">
                <button id="modBtn" type="button" class="btn btn-success me-2">ì €ì¥</button>
                <a th:href="@{/board/list}" class="btn btn-secondary">ëª©ë¡</a>
            </div>
        </th:block>
        </form>

        <section class="mt-5">
            <h3 class="mb-3">ëŒ“ê¸€</h3>
            <div class="card bg-light mb-4">
                <div class="card-body">
                    <div class="d-flex mb-3">
                        <textarea class="form-control" id="replyContent" name="replyContent" rows="2" placeholder="ëŒ“ê¸€ì„ ì‘ì„± í•´ì£¼ì„¸ìš”."></textarea>
                        <button type="button" id="replySave" class="btn btn-dark ms-2">ì €ì¥</button>
                    </div>

                    <div th:each="list : ${replyList}" class="comment-container">
                        <div class="d-flex mb-2">
                            <div class="flex-shrink-0"></div>
                            <div class="ms-3 w-100">
                                <div class="comment-header">ì‘ì„±ì: <span class="fw-bold" th:text="${list.userId}"></span></div>

                                <div class="d-flex align-items-center">
                                    <input type="hidden" name="replyNo" th:value="${list.replySno}">
                                    <input type="text" id="replyContentDisplay" class="replyContentArea form-control" th:value="${list.replyContent}" readonly />

                                    <a href="#" th:onclick="'javascript:updateReplyModalForm('+${list.replySno}+')'" class="btn btn-sm btn-info updateReply ms-2">ìˆ˜ì •</a>
                                    <a href="#" th:onclick="'javascript:delReply('+${list.replySno}+')'" class="btn btn-sm btn-danger delReply ms-2">ì‚­ì œ</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <div class="modal fade" id="updateReplyModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">ëŒ“ê¸€ ìˆ˜ì •</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                   <div class="col-md-12">
                       <input type="hidden" id="modalReplyNo" value="">
                      <textarea class="form-control" id="modalReplyContent" rows="3" placeholder="ìˆ˜ì • ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" id="modalReplyUpdate" >ì €ì¥</button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
              </div>
            </div>
        </div>
        </div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript" type="text/javascript">

    $(function () {
        // [1] ê²Œì‹œê¸€ ìˆ˜ì •/ì €ì¥
        $("#modBtn").on("click", function () {
            const boardSno = $("#boardSno").val();
            const params = {boardSno: boardSno, title: $("#title").val(), content: $("#content").val()};

            // URLì„ /api/board/{boardSno} í˜•íƒœë¡œ êµ¬ì„±í•˜ê±°ë‚˜, /api/board/ë¡œ í†µì¼
            $.ajax({
                url: "/api/board/" + (boardSno ? '' : 'reg'), // boardSnoê°€ ìˆìœ¼ë©´ ìˆ˜ì •, ì—†ìœ¼ë©´ ë“±ë¡
                type:"post",
                data: params,
                success: function (data) {
                    if(data.code === "1") alert("ì €ì¥ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.href = "/board/list";
                },
                error:function(e){
                    console.log(e);
                    alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        });

        // [2] ëŒ“ê¸€ ë“±ë¡
       $("#replySave").on("click", function () {
           // boardSnoëŠ” ê²Œì‹œê¸€ì˜ ê³ ìœ  ë²ˆí˜¸ì…ë‹ˆë‹¤.
           const params = {boardSno : $("#boardSno").val(), replyContent: $("#replyContent").val()};

           if (!params.replyContent.trim()) {
               alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
               return;
           }

           $.ajax({
               url: "/api/reply",
               type:"post",
               data: params,
               success: function (data) {
                   if(data.code === "1") alert("ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                   // í˜„ì¬ í˜ì´ì§€ë¡œ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ë¥¼ ì—…ë°ì´íŠ¸
                   location.reload();
               },
               error:function(e){
                   console.log(e);
                   alert("ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
               }
           });
       });
    });

    /**
     * ëŒ“ê¸€ ìˆ˜ì • ëª¨ë‹¬ í¼ ì—´ê¸° (ë¯¸ì™„ì„± ë¡œì§ ëŒ€ì²´)
     * ì‹¤ì œë¡œëŠ” í•´ë‹¹ ëŒ“ê¸€ì˜ ë‚´ìš©ì„ AJAXë¡œ ì¡°íšŒí•˜ì—¬ ëª¨ë‹¬ì— ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.
     */
    function updateReplyModalForm(sno) {
        // 1. ëª¨ë‹¬ì— ëŒ“ê¸€ ID ì €ì¥
        $("#modalReplyNo").val(sno);

        // 2. í˜„ì¬ ëŒ“ê¸€ ë‚´ìš©ì„ ì°¾ì•„ ëª¨ë‹¬ textareaì— ì„¤ì • (ì„ì‹œ ëŒ€ì²´)
        const currentContent = $(`input[name="replyNo"][value="${sno}"]`).closest('.ms-3').find('.replyContentArea').val();
        $("#modalReplyContent").val(currentContent);

        // 3. ëª¨ë‹¬ ì—´ê¸° (Bootstrap API)
        const updateReplyModal = new bootstrap.Modal(document.getElementById('updateReplyModal'));
        updateReplyModal.show();
    }

    // [3] ëª¨ë‹¬ ë‚´ ëŒ“ê¸€ ìˆ˜ì • ìµœì¢… ì €ì¥
    $("#modalReplyUpdate").on("click", function() {
        const replySno = $("#modalReplyNo").val();
        const replyContent = $("#modalReplyContent").val();
        const boardSno = $("#boardSno").val();

        const params = {replySno: replySno, replyContent: replyContent, boardSno: boardSno};

        $.ajax({
           url: "/api/reply/update", // ğŸ”‘ ìˆ˜ì • ì „ìš© API URL í•„ìš”
           type:"post", // PUT ë©”ì†Œë“œ ì‚¬ìš©ì´ ì •ì„ì´ì§€ë§Œ, í˜¸í™˜ì„±ì„ ìœ„í•´ POST ì‚¬ìš©
           data: params,
           success: function (data) {
               if(data.code === "1") alert("ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
               location.reload();
           },
           error:function(e){
               console.log(e);
               alert("ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
           }
       });
    });

    /**
     * ëŒ“ê¸€ ì‚­ì œ
     */
    function delReply(sno) {
        if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const params = {replySno: sno, boardSno: $("#boardSno").val()} // boardSnoëŠ” í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ì„ ìœ„í•´ ì „ë‹¬

        $.ajax({
           url: "/api/reply",
           type:"delete",
           data: params,
           success: function (data) {
               if(data.code === "1") alert("ì‚­ì œ ë˜ì—ˆìŠµë‹ˆë‹¤.");
               location.reload(); // ëŒ“ê¸€ ì‚­ì œ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
           },
           error:function(e){
               console.log(e);
               alert("ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
           }
       });
    }   

</script>

</body>
</html>