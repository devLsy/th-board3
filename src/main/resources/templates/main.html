<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>게시판 목록</title>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script th:src="@{/js/common.js}"></script>
    <link rel="stylesheet" th:href="@{/css/common.css}">
</head>
<body>
<div class="main-content-wrapper">

    <div class="sidebar-menu">
        <h3>게시판 메뉴</h3>
        <ul>
            <li class="active"><a th:href="@{/board/list}">게시판 목록</a></li>
            <li><a th:href="@{/survey/ext/list}">설문조사 관리</a></li>
            <li><a href="#">커뮤니티</a></li>
            <li><a href="#">관리자 대시보드</a></li>
        </ul>
    </div>

    <div class="content-area">

        <div class="action-bar-container">
            <div id="searchGroup">
                <form id="searchForm" class="d-flex">
                    <select name="type" id="type" class="form-select">
                        <option value="">전체</option>
                        <option value="T">제목</option>
                        <option value="C">내용</option>
                        <option value="W">작성자</option>
                    </select>
                    <input type="text" name="keyword" id="keyword" class="form-control">
                    <button type="button" id="searchBtn" class="action-btn">검색</button>
                </form>
            </div>

            <div class="button-group">
                <a th:href="@{/board/reg}" class="write-btn">글쓰기</a>
            </div>
        </div>

        <table class="styled-table">
            <thead>
                <tr>
                    <th>번호</th>
                    <th>제목</th>
                    <th>내용</th>
                    <th>작성자</th>
                    <th>등록일</th>
                    <th>삭제</th>
                </tr>
            </thead>
            <tbody id="boardBody"></tbody>
        </table>

        <div id="count"></div>

        <div class="tbl-paging"></div>
    </div>
</div>
<script th:inline="javascript" type="text/javascript">
    //구분
    const menu = "board";
    //검색조건
    let searchData = "";

    $(function () {
        // 페이지 로드 시 초기 리스트 조회
        getList("", 1, menu);
    });

    //검색
    $("#searchBtn").on("click", function (e) {
        e.preventDefault();
        searchData = $('#searchForm').serialize();
        getList(searchData, 1, menu);
    });

    /**
     * 페이지 이동
     * @param currentPage
     */
    function movePage(currentPage){
        (searchData !== "") ? getList(searchData, currentPage, menu) : getList("", currentPage, menu);
    }

    /**
     * ajax 통신으로 리스트를 조회한다.
     */
    function getList(searchParam, currentPage, type){
        console.log("getList!!!!");
        $.ajax({
           url: "/api/" + type +"?currentPage=" + currentPage,
           type:"get",
           data: searchParam,
           success: function (data){
              drawTbody(data, type);
              drawPagination(data.paging);
           },
           error:function(e){
               console.error("AJAX Error:", e);
           }
        });
    }

    /**
     * tbody에 html을 덮어쓴다. (템플릿 문자열 사용)
     */
    function drawTbody(data, gubun) {
        let targetTbody = "boardBody";
        let htmlData = "";
        let countHtml = "";

        if(!data || !data.list || data.list.length !== 0) {
            // foreach start
            for (let i = 0; i < data.list.length; i++) {
                const item = data.list[i];

                // 템플릿 문자열 (Template Literal) 사용
                htmlData += `
                    <tr data-sno="${item.boardSno}">
                        <td>${item.no}</td>
                        <td>
                            <a href='#' onclick='detail("${item.boardSno}")'>
                                ${item.title} [${item.replyCnt}]
                            </a>
                        </td>
                        <td>${item.content}</td>
                        <td>${item.userId}</td>
                        <td>${item.regDate}</td>
                        <td>
                            <a href='#' onclick='delBoard("${item.boardSno}")' class="delete-link-btn">삭제</a>
                        </td>
                    </tr>
                `;
            }
            // foreach end
        } else {
            htmlData = `
                <tr>
                    <td colspan="6" style="text-align: center; color: gray; padding: 20px;">
                        조회된 데이터가 없습니다.
                    </td>
                </tr>
            `;
        }
        // tbody에 반영
        $("#" + targetTbody).html(htmlData);

        // 카운트 반영
        const displayCount = (data && data.count) ? data.count : 0;
        $("#count").text(displayCount + "건");
    }

    //상세보기
    function detail(sno) {
        location.href = "/board/mod/" + sno;
    }

    function delBoard(sno) {
        if (!confirm("정말로 삭제하시겠습니까?")) return;

        $.ajax({
            url: "/api/board/" + sno,
            type:"delete",
            success: function (data) {
                if(data.code === "1") alert("삭제 되었습니다.");
                location.href = "/board/list"
            },
            error:function(e){
                console.log(e);
                alert("삭제 중 오류가 발생했습니다.");
            }
        });
    }
</script>

</body>
</html>